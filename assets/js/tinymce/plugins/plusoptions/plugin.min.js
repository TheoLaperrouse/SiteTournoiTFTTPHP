tinymce.create('tinymce.plugins.plusoptions', {
	init : function(ed, url) {
		//console.log("plusoptions", ed);
		// if (ed.inline) {
			// console.log('inline');
			// $("div[role='toolbar']:last",$(".mce-floatpanel")).hide();
			// $("div[role='menubar']",$(".mce-floatpanel")).hide();
		// }
		
		ed.addButton( 'plusoptions', {
			type: 'button',
			text: '',
			image: tinymce.baseURL + '/plugins/plusoptions/plus.png',
			icon: true,
			tooltip: "plus d'options (police, taille, hauteur de lignes ...",
			onclick: function() {
				if (ed.inline) {
					//console.log('inline');
					$(".mce-floatpanel").each(function(index,v) {
						var id = $(this).attr('id') ;
					//console.log(id);
						$("div[role='toolbar']:last",$("#"+id)).toggle();
						$("div[role='menubar']",$("#"+id)).toggle();
						
						var $i = $("i",$("#"+id)).filter(function () {
								return $(this).css("background-image").toLowerCase().indexOf(tinymce.baseURL.toLowerCase() + '/plugins/plusoptions/plus.png') >= 0 || 
										$(this).css("background-image").toLowerCase().indexOf(tinymce.baseURL.toLowerCase() + '/plugins/plusoptions/minus.png') >= 0;
							}).first();
							
						//console.log($i.css("background-image"));
						
						if ($i.css("background-image").toLowerCase().indexOf(tinymce.baseURL.toLowerCase() + '/plugins/plusoptions/plus.png') >= 0) {
							//console.log('change to minus');
							$i.css("background-image","url('"+tinymce.baseURL + "/plugins/plusoptions/minus.png')");
						} else if ($i.css("background-image").toLowerCase().indexOf(tinymce.baseURL.toLowerCase() + '/plugins/plusoptions/minus.png') >= 0) {
							//console.log('change to plus');
							$i.css("background-image","url('"+tinymce.baseURL + "/plugins/plusoptions/plus.png')");
						}
					});
				} else {
					var id = ed.editorContainer.id ;
					//console.log('plusoptions click', id);
					$("div[role='toolbar']:last",$("#"+id)).toggle();
					$("div[role='menubar']",$("#"+id)).toggle();
					
					var $i = $("i",$("#"+id)).filter(function () {
							return $(this).css("background-image").toLowerCase().indexOf(tinymce.baseURL.toLowerCase() + '/plugins/plusoptions/plus.png') >= 0 || 
									$(this).css("background-image").toLowerCase().indexOf(tinymce.baseURL.toLowerCase() + '/plugins/plusoptions/minus.png') >= 0;
						}).first();
						
					//console.log($i.css("background-image"));
					
					if ($i.css("background-image").toLowerCase().indexOf(tinymce.baseURL.toLowerCase() + '/plugins/plusoptions/plus.png') >= 0) {
						//console.log('change to minus');
						$i.css("background-image","url('"+tinymce.baseURL + "/plugins/plusoptions/minus.png')");
					} else if ($i.css("background-image").toLowerCase().indexOf(tinymce.baseURL.toLowerCase() + '/plugins/plusoptions/minus.png') >= 0) {
						//console.log('change to plus');
						$i.css("background-image","url('"+tinymce.baseURL + "/plugins/plusoptions/plus.png')");
					}
				}
				//console.log('changement fait', $i.css("background-image"));
				return false;
			},
			onPostRender: function () {
				//console.log(ed);
				ed.on('init', function() {
					if (!ed.inline) {
						var id = ed.editorContainer.id ;
						//console.log(id);
						$("div[role='toolbar']:last",$("#"+id)).hide();
						$("div[role='menubar']",$("#"+id)).hide();
					}
				});
				ed.on('focus', function() {
					if (ed.inline) {
						//console.log('focus inline');
						$("div[role='toolbar']:last",$(".mce-floatpanel")).hide();
						$("div[role='menubar']",$(".mce-floatpanel")).hide();
					}
				});
			 }
		});
	}
});

// register our custom plugin
tinymce.PluginManager.add('plusoptions', tinymce.plugins.plusoptions);